
set @placement_list='d589a0c4c8113905178385eca5a49b57,bdfe0b7f746717e48bcb2561bb7f9d52,99c5e1c8c02010078c4e5a23b7dbce60,8924590a7b4ca094066b109f73a83f08,82c95db7088f88056a6ca7f4ab47c7f6,3104e50e9761e20757f2a2f5c0179409,d589a0c4c8113905178385eca5a49b57,bdfe0b7f746717e48bcb2561bb7f9d52,99c5e1c8c02010078c4e5a23b7dbce60,8924590a7b4ca094066b109f73a83f08,82c95db7088f88056a6ca7f4ab47c7f6,3104e50e9761e20757f2a2f5c0179409,98f6571e4da48d43eedf0ffff7e725fd,bc060644f6bb1b52c862fdff6928a1f9,c7dfbbb336c98c995e6ee5ea12825118,9733ffaaa1a11c3cf151c63e37f7942e,b999eacaa06228bef9700183b1c8f505,a697e99c4891010bc7b35025cd0741a0,d374c5fac1b7399a8bccffa2446d5403,e08f7dfcdf9d117fb7988f7e67f5c5f8,3241c1ed3732ffc1363859a9c3f741dd,69680f56eef5f5ffe4c7988e41d4d881,9f0f0a7d4107894f2863289e4ccf3863,557067c5f474611c39cff023db27de83,39dc8136daec05641772d370c03eebac,b1e173ca345829c8d0bcd00d7c6d3b53,acfbd7b1f1aa9da142cbaab752bc9308,b47b976e9832bc9c5f2711141a83b915,24078faaca056667ef38a74a8b68be4c,080f101152e67192b7dfc0621f2ac60f,28eac875355a56c456abfcf43c26244a,6fcddde3f881ef082c7d082a6ff1bf33,1928c32460502fdcc50d9ded21ed062a,98f6571e4da48d43eedf0ffff7e725fd,bc060644f6bb1b52c862fdff6928a1f9,c7dfbbb336c98c995e6ee5ea12825118,9733ffaaa1a11c3cf151c63e37f7942e,b999eacaa06228bef9700183b1c8f505,e08f7dfcdf9d117fb7988f7e67f5c5f8,a697e99c4891010bc7b35025cd0741a0,c217b382bd0bb7d88db412a2974e82de,d374c5fac1b7399a8bccffa2446d5403,508abda3b4e139bae6bf26f2213410ce,508abda3b4e139bae6bf26f2213410ce,c5d7fce832be89d99bf7c8142d940d55,c5d7fce832be89d99bf7c8142d940d55,15d05a3dacaf3b0b2c7272a0b3244c9d,9a8976407378bcd07f415f64a61f4bf7,e3a524f867585e6128a15630561ac8d6,2c9785fbb0fd3cdcd8473d37008c1b7e,65015fc94165d53ed165b0e0b8a0cf19';
set @start_date='2016-10-01';


select plcmnts.*
	, date(dt.dt) date_    
    , substring_index(group_concat(floor order by fh.timestamp desc),',',1) floor_price
    , substring_index(group_concat(elt(gh.new_value,'A','B','C','A+','C+','G','G-','Kbidder','Max Fill Low FP','VH margin') order by gh.timestamp desc),',',1) goal_type
    , r.impressions
    , r.served
    , concat(round(100*r.served/r.impressions,1),'%') fill
    , round(1000*(r.cost+r.profit)/r.served,2) ecpm
    , r.cost+r.profit revenue
    , r.profit   
from (select layoutid tagid	
	, substring_index(s.sitename,'(',1) site
    , replace(substring_index(l.tag_url,'//',-1),'www.','') url
	, l.name
	from kmn_layouts l
    inner join kmn_sites s using(siteid)
    where layoutid in ('c9fc04b4f883b8a4222b4234610ba9b9',
'7c10dfa69635f91fe535293df4bd6044',
'90b1fc7e2d0ebe9e1d05f97bdd0b74b6',
'c4ff737e5f3aa5c7ac4712d48283b881',
'bc598d051d958ee64ea7829ab545cc4d',
'99c5e1c8c02010078c4e5a23b7dbce60',
'bdfe0b7f746717e48bcb2561bb7f9d52',
'd589a0c4c8113905178385eca5a49b57',
'39c0e28a83f8a9f7e502ea3061d9ed72',
'0fc407434f2da6cba5b4d14c8008706a',
'6c1a82b67b8e797c6856d4b96908c646',
'b05300eda9327cfb3222bcb56447b40a',
'b186cfb71f02e0fa63cd492cba5d9fe9',
'1a8cdc0b0c5ad696889713503aead370',
'6e837d0c0dd1c7ea7f118b1bfe97c30c',
'e2da2fc669cee078ce0af829fe6584f6',
'f7c55a359ade1bce2e1304c68664b52f',
'e36e0f28cbef1307793630b59772de5e',
'2e4b7bd8055acc1a271ec4ae882f8318',
'8470a676da3f37cb2812ca3b8f995ea3',
'e651efd3d437e4bab00a3822ecafb9a4',
'0056f83a6ae8376d4ea24598876c4353',
'5bd191068b8d836a2bf55ab3e7bbe8fd',
'96804fb1311a7ab4af43929a2cc4eaa2',
'ee3c55024b0b75f5420763bfacb46273',
'e38bd8eb7a5d2d1b1075b954194d4b6a',
'007f3a45ebb73838c1d7628d4b9dbb05',
'4915b645a4e8cd4d3f907df1b4d8b1e9',
'a757133bf6f729778b0b0a1f849cb79f',
'a4384fb2c8a164943cd5ad32be219ed9',
'74c61d1e3a03145f370446fc6a2da28d',
'219416a4027fe3fe10bfb7515b70d87c',
'7588638638a102d264a871069ecbdc29',
'12a13e8b6970790a15924db78a44ef09',
'39bdfdc95be0f922bc4a5a5e38981540',
'40df45fe3753864eb22c6872c80889c9',
'9069688e176f622db83b5abf453bbc0f',
'3eed1506a416927dcb8629896e2674e5',
'0c604886aa127e21411dd3bc758dec2c',
'76f97c1cb0a8d79b8df3d4ae82a06efa',
'0a4642e55ba4cd9dfbda79a6cc4482ba',
'41d33949c75accbc3657781e427b734d',
'73deef5b069fb5ead8d13df8ce24aba4',
'7973050f1fcae4317d4e63d6918ef0d8',
'da0db452f58a4f85954bf78840f82552',
'cc439fb00ebdc83728a08e12dd2504db',
'4a2b8308c725f8c538fbf79d3d25a32d',
'76c870c65c542e5c4f5738489d54e28f',
'd69e10d09cca51dfd3f0a074415a0688',
'e46456e7688ee9dea3b5c439f93a0d40',
'999e2ac22723ae740381dbf9bf75c050',
'ade22c3333abaca29c0cfbd46ae68730',
'a9d5120323822fda58c4fb7b81f88978',
'7471eee66b508a4b2d07625623685eca',
'bd6a1af8f69e06e284279e7c13a561f9',
'd9a7a800e06d49eb5428d8196d3c0998',
'720e5e839fcee8b931401f4650d90c05',
'264fe560872a6592dd22d52d311412dc',
'd147cd151b830e192002d95fe36395a4',
'1084fc636815cbd433a5caef1ceb5953',
'12e90a36ea70e4a58f0eda1033108a87',
'1e7d4d6cc0252d496c9bd3af80db63ed',
'279dae27bb05efc4583c085866bea58e',
'29fb5b72175a9429f17c7ff36e64568b',
'3168055598cf9414d239ae592b30bc5a',
'4b04804bad88916ba26f4cf747b98a14',
'7a04c0dfa4f4871328de1dd741595012',
'7baaf0737dd792af7baa94854f54a346',
'9de9415d2b34d93155f1938250a1885e',
'bb5fbea4220c3bf441dc59019095aeca',
'c0e686e34c116a3861d61160c0edb51c',
'c2367664979cb2e7ceaee721a1ab4116',
'd019d0054972a65f86dd4bff5300066a',
'e664d057e00d2e7e52da4e25e8bda1a4',
'e6fa8fd19d8e8427b4ae971e18801083',
'ec2909d439a84ad5ac2dd73e3bbe9d46',
'14090b08693166a6a1bd737811c9fa4b',
'2c63cd44fa10990f1e8f571f9e12ed5e',
'438d06f945b42aa24a3b17d69a47867e',
'8b05c5124c41fa29c85fd84e0e9c611f',
'ace5cf45d1bcd91d77eeb0b86d5bc2a4',
'b1ec42b7118e96f5207adec4ff3e499a',
'219affc912ba5f6782fcd9c96a268f06',
'428b0312910695e96411f89bff0848cd',
'4dbf92819ea9f8b5b30db46adefe6aa1',
'53f8b3ca4ba11a924ba614a85f6fc50d',
'5d5830bef64c447270e3cb9f9a99757f',
'd0f8134c4f6ff74ed03450876e7eccb5',
'd9b871fdc444c5516bcbb107eb372685',
'da7123ac532f69c7b9f24c2f0e9376ea',
'ee77ef2d2ad971aabdfc1ecc0704036d',
'f1c180f4837033a5b6bb2fbf39b27513',
'21419271a6d033c131e618c907c88c4d',
'1a5bb2bcccf4ee6f16c08a55fdb4f9cd',
'88fea04b2e91909f424834cb60c2580c',
'93a736ce1753223adecaa9b8daac45d9',
'04f2f8608fafea33c71b357393b08b2f',
'482dce076a6fc1e437ad0aaef08de43e',
'7d58b08235b9b264e9a076e781d0bdd4',
'0b2ffcc00a6b5656a13997f422a02f65',
'14bb35db56d2d26a4144fecd65c91d06',
'a7879a898b3534ff0d5de0e307892554',
'00f411eda75a124b9e57299792cfb03e',
'0dbc0d164bb556baa29be450367f4839',
'6e67481cbe66e4eaff29c7de3a2c3bb7',
'9e436d3519fefc5d14339a74194c7955',
'b9d65da312d420dab019db016a81f08c',
'f0f3211700d2b771460718e33412b657',
'c50e0688bb175c0a0b3399bd39e76f08',
'24fa8d25a8f3773de6a54527d62d70f2',
'944d16f717e7f57bbcc515454fd2d56f',
'10533ae1c636bf73cf8fdb98642f776c',
'192e8371ab5684ece4b803ecb3ad0f1a',
'47973d2bca0d11948f7084bcef6c94c4',
'65af7dde51a5e6657df3c833a2efda4c',
'68c6e8e92d40144c1af249ecf2a23e41',
'8d466d2748b001f22e956165711d1b2b',
'c02d68e731ef544ca58ce33d16deae8f',
'ee2488a5e14c56764195c7cd82cfbed9',
'fbcdc77ef23395b2027e0c9f1b0d2534',
'138b1c94ca3c7157a42c02f2d778bedd',
'c41358ebc040d060841b308451ad7cd9',
'5bd76146a3022b2ef1d41f8efb5c6561',
'd19e4ca7ceb07d04c80f41902a5bfaa8',
'efc9c6106d7bd7d95033a4366e77f60c',
'5774e7b66748210d8717680b97699172',
) plcmnts
join calendar dt on dt between @start_date and current_date()
left join kmn_floor_prices_history fh 
    on fh.date <= dt.dt
	and fh.tagid=plcmnts.tagid
left join kmn_history gh
	on gh.timestamp <= unix_timestamp(dt.dt)
    and gh.entity_id=plcmnts.tagid
    and gh.field='optimization_goal_id'
    and gh.entity_type='placement'
left join kmn_tag_report r 
	on r.tagid=plcmnts.tagid
    and r.date=date(dt.dt)
group by tagid, date_
order by tagid, date_;